import os
import pytest
from bofhound.ad.models.bloodhound_computer import BloodHoundComputer
from bofhound.parsers.ldap_search_bof import LdapSearchBofParser
from bofhound.ad.adds import ADDS
from tests.test_data import *


def test_parse_file_ldapsearchpyNormalFile(ldapsearchpy_standard_file_516):
    parsed_objects = LdapSearchBofParser.parse_file(ldapsearchpy_standard_file_516)
    assert len(parsed_objects) == 516


def test_parse_file_ldapsearchbof_NormalFile(ldapsearchbof_standard_file_257):
    parsed_objects = LdapSearchBofParser.parse_file(ldapsearchbof_standard_file_257)
    assert len(parsed_objects) == 257


def test_parse_data_computer():
    data = """dSCorePropagationData: 16010101000000.0Z
--------------------
objectClass: top, person, organizationalPerson, user, computer
cn: WIN10
distinguishedName: CN=WIN10,OU=Workstations,DC=windomain,DC=local
instanceType: 4
whenCreated: 20220112013543.0Z
whenChanged: 20220401134507.0Z
uSNCreated: 14202
uSNChanged: 24046
nTSecurityDescriptor: AQAEjJgJAAC0CQAAAAAAABQAAAAEAIQJMQAAAAUASAAgAAAAAwAAABAgIF+ledARkCAAwE/C1M+Gepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUASAAgAAAAAwAAAFB5lr/mDdARooUAqgAwSeKGepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUASAAgAAAAAwAAAFN5lr/mDdARooUAqgAwSeKGepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUASAAgAAAAAwAAANC/Cj5qEtARoGAAqgBsM+2Gepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUAOAAIAAAAAQAAAEeV43IYe9ERre8AwE/Y1c0BBQAAAAAABRUAAAA2jAHbq49waZF5SUXoAwAABQA4AAgAAAABAAAAiEem8wZT0RGpxQAA+ANnwQEFAAAAAAAFFQAAADaMAdurj3BpkXlJRegDAAAFADgAIAAAAAEAAAAAQhZMwCDQEadoAKoAbgUpAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUAOAAwAAAAAQAAAH96lr/mDdARooUAqgAwSeIBBQAAAAAABRUAAAA2jAHbq49waZF5SUUFAgAABQAsAAMAAAABAAAAqHqWv+YN0BGihQCqADBJ4gECAAAAAAAFIAAAACYCAAAFACwAEAAAAAEAAAAdsalGrmBaQLfo/4pY1FbSAQIAAAAAAAUgAA

04/01 19:35:34 UTC [output]
received output:
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
name: WIN10
objectGUID: f981e173-4db8-48f9-9c2d-3d4987698505
userAccountControl: 4096
badPwdCount: 0
codePage: 0
countryCode: 0
badPasswordTime: 0
lastLogoff: 0
lastLogon: 132933148216284771
localPolicyFlags: 0
pwdLastSet: 132888464114765330
primaryGroupID: 515
objectSid: S-1-5-21-3674311734-1768984491-1162443153-1104
accountExpires: 9223372036854775807
logonCount: 222
sAMAccountName: WIN10$
sAMAccountType: 805306369
operatingSystem: Windows 10 Enterprise Evaluation
operatingSystemVersion: 10.0 (18363)
dNSHostName: win10.windomain.local
servicePrincipalName: WSMAN/win10, WSMAN/win10.windomain.local, TERMSRV/WIN10, TERMSRV/win10.windomain.local, RestrictedKrbHost/WIN10, HOST/WIN10, RestrictedKrbHost/win10.windomain.local, HOST/win10.windomain.local
objectCategory: CN=Computer,CN=Schema,CN=Configuration,DC=windomain,DC=local
isCriticalSystemObject: FALSE
dSCorePropagationData: 20220325174020.0Z, 16010101000001.0Z
lastLogonTimestamp: 132932943074365707
msDS-SupportedEncryptionTypes: 28
ms-Mcs-AdmPwd: testpassword
ms-Mcs-AdmPwdExpirationTime: 13295315246991474
--------------------
    """
    parsed_objects = LdapSearchBofParser.parse_data(data)

    assert len(parsed_objects) == 1
    assert 'operatingsystem' in parsed_objects[0].keys()
    assert 'operatingsystem' in BloodHoundComputer(parsed_objects[0]).Properties.keys()


def test_parse_lower_data_computer():
    data = """dSCorePropagationData: 16010101000000.0Z
--------------------
objectclass: top, person, organizationalPerson, user, computer
cn: WIN10
distinguishedname: CN=WIN10,OU=Workstations,DC=windomain,DC=local
instancetype: 4
whencreated: 20220112013543.0Z
whenchanged: 20220401134507.0Z
usncreated: 14202
usnchanged: 24046
ntsecuritydescriptor: AQAEjJgJAAC0CQAAAAAAABQAAAAEAIQJMQAAAAUASAAgAAAAAwAAABAgIF+ledARkCAAwE/C1M+Gepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUASAAgAAAAAwAAAFB5lr/mDdARooUAqgAwSeKGepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUASAAgAAAAAwAAAFN5lr/mDdARooUAqgAwSeKGepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUASAAgAAAAAwAAANC/Cj5qEtARoGAAqgBsM+2Gepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUAOAAIAAAAAQAAAEeV43IYe9ERre8AwE/Y1c0BBQAAAAAABRUAAAA2jAHbq49waZF5SUXoAwAABQA4AAgAAAABAAAAiEem8wZT0RGpxQAA+ANnwQEFAAAAAAAFFQAAADaMAdurj3BpkXlJRegDAAAFADgAIAAAAAEAAAAAQhZMwCDQEadoAKoAbgUpAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUAOAAwAAAAAQAAAH96lr/mDdARooUAqgAwSeIBBQAAAAAABRUAAAA2jAHbq49waZF5SUUFAgAABQAsAAMAAAABAAAAqHqWv+YN0BGihQCqADBJ4gECAAAAAAAFIAAAACYCAAAFACwAEAAAAAEAAAAdsalGrmBaQLfo/4pY1FbSAQIAAAAAAAUgAA

04/01 19:35:34 UTC [output]
received output:
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
name: WIN10
objectguid: f981e173-4db8-48f9-9c2d-3d4987698505
useraccountcontrol: 4096
badpwdcount: 0
codepage: 0
countrycode: 0
badpasswordtime: 0
lastlogoff: 0
lastlogon: 132933148216284771
localpolicyflags: 0
pwdlastset: 132888464114765330
primarygroupid: 515
objectsid: S-1-5-21-3674311734-1768984491-1162443153-1104
accountexpires: 9223372036854775807
logoncount: 222
samaccountname: WIN10$
samaccounttype: 805306369
operatingsystem: Windows 10 Enterprise Evaluation
operatingsystemversion: 10.0 (18363)
dnshostname: win10.windomain.local
serviceprincipalname: WSMAN/win10, WSMAN/win10.windomain.local, TERMSRV/WIN10, TERMSRV/win10.windomain.local, RestrictedKrbHost/WIN10, HOST/WIN10, RestrictedKrbHost/win10.windomain.local, HOST/win10.windomain.local
objectcategory: CN=Computer,CN=Schema,CN=Configuration,DC=windomain,DC=local
iscriticalsystemobject: FALSE
dscorepropagationdata: 20220325174020.0Z, 16010101000001.0Z
lastlogontimestamp: 132932943074365707
msds-supportedencryptiontypes: 28
ms-mcs-admpwd: testpassword
ms-mcs-admpwdexpirationtime: 13295315246991474
--------------------
    """
    parsed_objects = LdapSearchBofParser.parse_data(data)
    ad = ADDS()
    ad.import_objects(parsed_objects)

    assert len(parsed_objects) == 1
    assert 'operatingsystem' in parsed_objects[0].keys()
    assert 'operatingsystem' in BloodHoundComputer(parsed_objects[0]).Properties.keys()
    assert len(ad.computers) == 1


def test_parse_data_computer_data_missing_dn():
    data = """dSCorePropagationData: 16010101000000.0Z
--------------------
objectClass: top, person, organizationalPerson, user, computer
cn: WIN10
instanceType: 4
whenCreated: 20220112013543.0Z
whenChanged: 20220401134507.0Z
uSNCreated: 14202
uSNChanged: 24046
nTSecurityDescriptor: AQAEjJgJAAC0CQAAAAAAABQAAAAEAIQJMQAAAAUASAAgAAAAAwAAABAgIF+ledARkCAAwE/C1M+Gepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUASAAgAAAAAwAAAFB5lr/mDdARooUAqgAwSeKGepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUASAAgAAAAAwAAAFN5lr/mDdARooUAqgAwSeKGepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUASAAgAAAAAwAAANC/Cj5qEtARoGAAqgBsM+2Gepa/5g3QEaKFAKoAMEniAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUAOAAIAAAAAQAAAEeV43IYe9ERre8AwE/Y1c0BBQAAAAAABRUAAAA2jAHbq49waZF5SUXoAwAABQA4AAgAAAABAAAAiEem8wZT0RGpxQAA+ANnwQEFAAAAAAAFFQAAADaMAdurj3BpkXlJRegDAAAFADgAIAAAAAEAAAAAQhZMwCDQEadoAKoAbgUpAQUAAAAAAAUVAAAANowB26uPcGmReUlF6AMAAAUAOAAwAAAAAQAAAH96lr/mDdARooUAqgAwSeIBBQAAAAAABRUAAAA2jAHbq49waZF5SUUFAgAABQAsAAMAAAABAAAAqHqWv+YN0BGihQCqADBJ4gECAAAAAAAFIAAAACYCAAAFACwAEAAAAAEAAAAdsalGrmBaQLfo/4pY1FbSAQIAAAAAAAUgAA

04/01 19:35:34 UTC [output]
received output:
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
name: WIN10
objectGUID: f981e173-4db8-48f9-9c2d-3d4987698505
userAccountControl: 4096
badPwdCount: 0
codePage: 0
countryCode: 0
badPasswordTime: 0
lastLogoff: 0
lastLogon: 132933148216284771
localPolicyFlags: 0
pwdLastSet: 132888464114765330
primaryGroupID: 515
objectSid: S-1-5-21-3674311734-1768984491-1162443153-1104
accountExpires: 9223372036854775807
logonCount: 222
sAMAccountName: WIN10$
sAMAccountType: 805306369
operatingSystem: Windows 10 Enterprise Evaluation
operatingSystemVersion: 10.0 (18363)
dNSHostName: win10.windomain.local
servicePrincipalName: WSMAN/win10, WSMAN/win10.windomain.local, TERMSRV/WIN10, TERMSRV/win10.windomain.local, RestrictedKrbHost/WIN10, HOST/WIN10, RestrictedKrbHost/win10.windomain.local, HOST/win10.windomain.local
objectCategory: CN=Computer,CN=Schema,CN=Configuration,DC=windomain,DC=local
isCriticalSystemObject: FALSE
dSCorePropagationData: 20220325174020.0Z, 16010101000001.0Z
lastLogonTimestamp: 132932943074365707
msDS-SupportedEncryptionTypes: 28
ms-Mcs-AdmPwd: testpassword
ms-Mcs-AdmPwdExpirationTime: 13295315246991474
--------------------
    """
    parsed_objects = LdapSearchBofParser.parse_data(data)
    ad = ADDS()
    ad.import_objects(parsed_objects)

    assert len(parsed_objects) == 1
    # this test is failing - should distinguishedname be required?
    assert len(ad.computers) == 0


def test_parse_mininal_data_computer():
    data = """dSCorePropagationData: 16010101000000.0Z
--------------------
distinguishedName: CN=WIN10,OU=Workstations,DC=windomain,DC=local
objectSid: S-1-5-21-3674311734-1768984491-1162443153-1104
sAMAccountType: 805306369
--------------------
    """
    parsed_objects = LdapSearchBofParser.parse_data(data)
    ad = ADDS()
    ad.import_objects(parsed_objects)

    assert len(parsed_objects) == 1
    assert len(ad.computers) == 1

